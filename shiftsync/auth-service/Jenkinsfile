pipeline {
  agent any

  environment {
    IMAGE_NAME = "australia-southeast1-docker.pkg.dev/shiftsync-gcp/shiftsync-repo/auth-service"
    REGISTRY_CREDENTIALS = credentials('gcp-artifact-creds')
  }

  stages {

    stage('Build & Push Docker Image') {
      steps {
        script {
          def dockerLogin = 'echo %REGISTRY_CREDENTIALS_PSW% | docker login -u _json_key --password-stdin https://australia-southeast1-docker.pkg.dev'

          bat """
            cd auth-service
            docker build -t ${IMAGE_NAME}:latest .
            ${dockerLogin}
            docker push ${IMAGE_NAME}:latest
          """
        }
      }
    }

    stage('Run Unit Tests') {
      steps {
        bat """
          cd auth-service
          npm install
          start /B node auth.js
          timeout /T 3
          npm test
        """
      }
    }

  }
}